<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="js/vue.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
	<title>Relatório de Vendas</title>
</head>
<body>
	<div id="app">
		<div class="container">
			<h1 class="mt-3">{{ title }}</h1>
			<table class="mt-5 table" v-if="salesByProduct">
				<thead>
					<tr>
						<th>Id</th>
						<th>Nome</th>
						<th>Total</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="(sale, index) in salesByProduct">
						<td>#{{ index + 1 }}</td>
						<td>{{ sale.name }}</td>
						<td v-money="'R$'">{{ sale.value }}</td>
					</tr>
				</tbody>
				<tfoot>
					<tr>
						<td>+</td>
						<td>Total</td>
						<td v-money="'R$'">{{ calculeteTotal(salesByProduct) }}</td>
					</tr>
				</tfoot>
			</table>

			<h2 class="mt-5">{{ register }}</h2>
			<table class="mt-5 table">
				<thead>
					<tr>
						<th>Id</th>
						<th>Nome</th>
						<th>Preço</th>
						<th>Qtde</th>
						<th>Data</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="sale in sales">
						<td>#{{ sale.id }}</td>
						<td>{{ sale.name }}</td>
						<td v-money="'R$'">{{ sale.price }}</td>
						<td>{{ sale.qtde }}</td>
						<td>{{ sale.date }}</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	<script>
		Vue.directive('money', {
			inserted(el, biding) {
				const amount = parseFloat(el.innerHTML).toFixed(2)
					.replace('.',',')
					.replace(/(\d)(?=(\d{3})+\,)/g, '$1.')

				el.innerHTML = `${biding.value} ${amount}`
			}
		})
		new Vue({
			el: '#app',
			data: {
				title: 'Relatório de Vendas',
				register: 'Registro de Vendas',
				sales: null,
			},
			methods: {
				getSales() {
					fetch('./data/sales.json')
						.then(resp => resp.json())
						.then(data => this.sales = data);
				},
				calculeteTotal(sales) {
					if(!sales) return 0
					return sales.reduce((total, sale) => total + sale.value, 0)
				}
			},
			computed: {
				salesByProduct() {
					if (!this.sales) return null
					const salesByProduct = this.sales.reduce((grouped, sale) => {
						if(!grouped.hasOwnProperty(sale.name)) {
							grouped[sale.name] = {
								name: sale.name,
								value: sale.price * sale.qtde
							}
							return grouped;
						}

						grouped[sale.name].value += sale.price * sale.qtde
						return grouped
					}, {})

					return Object.values(salesByProduct)
				}
			},
			mounted() {
				this.getSales();
			}
		});
	</script>
</body>
</html>
